<!DOCTYPE html>
<html>
<head>
    <title>Lawyer's Quest - Game Map</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='game-style.css') }}">
    <script>
    function updateStatus() {
    $.ajax({
        url: '/ajax_status',
        type: 'GET',
        success: function(response) {
          if (response.hunger !== undefined) {
                 $("#hunger-bar").text(`ğŸ— Hunger: ${response.hunger}%`);
             }
             if (response.xp !== undefined) {
                 $("#xp-display").text(`â­ XP: ${response.xp}`);
             }
             if (response.gold !== undefined) {
                 $("#gold-display").text(`ğŸ’° Bitcoin: ${response.gold}`);
             }
             if (response.progress_bar !== undefined) {
                 $("#progress-bar").text(`${response.progress_bar}`);
             }
             if (response.position !== undefined) {
                 const [x, y] = response.position;
                 $("#position").text(`ğŸ“ Position: (${x}, ${y})`);
             }
         },
         error: function () {
             console.error("âš ï¸ Failed to fetch status updates");
         }
     });
 }

      </script>
</head>
<body>
    <h1>ğŸ—ºï¸ Lawyer's Quest - Game Map</h1>
    <table><tr><td><p>ğŸ® Controls: Use <b>N S E W</b> to move | I shows your Inventory | V takes you to Town</p></td>
      <td><a href="{{ url_for('getting_started') }}">Getting Started with the Game</a></td></tr>
    </table>
    
    <table><tr><td>
  <span id="xp-display">ğŸ–ï¸ XP: {{ xp }}</span>
  <span id="gold-display">ğŸ’° Bitcoin: {{ gold }}</span>
</td><td>Quest {{quest_id}} <span id="progress-bar">Progress: {{progress_bar}}</span></td><td> ğŸ”¼ Level: {{ level }} </td><td><span id="position">{{ position }}</span></td></tr>
    <tr><td><span id="hunger-bar">ğŸ½ï¸ Hunger: {{ hunger }}</span> </td><td colspan="3"><span id="game-message"> {{ session.get('message', '') | safe }}</span></td></tr>
  </table>

    <div id="game-map">{{ game_map|safe }}</div>


    <div>
      <button class="move-btn" data-direction="N">â¬†ï¸ North</button>
      <button class="move-btn" data-direction="S">â¬‡ï¸ South</button>
      <button class="move-btn" data-direction="E">â¡ï¸ East</button>
      <button class="move-btn" data-direction="W">â¬…ï¸ West</button>
    </div>

    <script>
    function move(direction) {
    console.log("ğŸš€ Sending move request:", direction);  // âœ… Log movement request
    $.ajax({
        url: '/ajax_move',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ direction: direction }),
        success: function(response) {
            console.log("ğŸš€ Move response received:", response);  // âœ… Log full JSON response

            if (!response.map) {
                console.error("âŒ ERROR: data.map is undefined!", response);
            }

            // âœ… Update the game map if new map data is received
            if (response.map) {
                console.log("ğŸš€ Updating map display...");
                $("#game-map").html(response.map);
            }
            if (response.position) {
                const [x, y] = response.position;
                $("#position").text(`ğŸ“ Position: (${x}, ${y})`);
            }

            if (response.message) {
                $("#game-message").html(response.message.replace(/\n/g, "<br>"));
            }
            updateStatus();

            if (response.redirect) {
                window.location.href = response.redirect;
            }

            if (response.event === "treasure") {
                console.log("ğŸ Treasure chest found! Redirecting...");
                setTimeout(() => { window.location.href = "/treasure_encounter"; }, 500);
            } else if (response.event === "enemy") {
                console.log("âš”ï¸ Combat triggered! Redirecting...");
                setTimeout(() => { window.location.href = "/encounter_enemy"; }, 500);
            } else if (response.event === "riddle") {
                window.location.href = "/riddle_encounter";
            } else if (response.event === "town") {
                console.log("ğŸ° Heading to Town...");
                window.location.href = "/town";
            } else if (response.event === "npc") {
                console.log("NPC interaction....");
                window.location.href = "/npc";
            } else if (response.event === "inventory") {
                window.location.href = "/inventory";
            } else if (response.event === "q14bossfight") {
              setTimeout(() => { window.location.href = "/encounter_boss"; }, 500);
            }
        },
        error: function(xhr) {
            console.error("âŒ Error updating movement:", xhr.responseJSON);
            alert("Error: " + xhr.responseJSON.error);
        }
    });
}


    // âœ… **Button Clicks for Movement**
    $(".move-btn").click(function() {
        let direction = $(this).data("direction");
        move(direction);
    });

    // âœ… **Keyboard Event Listener for NSEW + V**
    $(document).keydown(function(event) {
        let keyMap = {
            78: "N",  // N key
            83: "S",  // S key
            69: "E",  // E key
            87: "W",  // W key
            86: "V",   // V key for Town Visit
            73: "I"
        };

        if (event.which in keyMap) {
          console.log("Key Pressed:", event.which, "Mapped to:", keyMap[event.which]);
          move(keyMap[event.which]); // Call move function with the corresponding action
        }
    });
</script>

    <br>
    <a href="{{ url_for('logout') }}">Logout</a>


</body>
</html>
