{% extends 'base.html' %}
{% block title %}{{ '🔨 Roaming Blacksmith 🔨' }}{% endblock %}

{% block content %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn   = document.getElementById('accept_button');
    if (!btn) return;

    // 1) enable the button now that we know there's an offer
    btn.disabled = false;

    // 2) when clicked, shove the offer into the bitcoin field and submit
    btn.addEventListener('click', () => {
      const offer = btn.getAttribute('data-offer');
      const form  = btn.closest('form');
      form.elements['bitcoin'].value = offer;
      form.submit();
    });
  });
</script>


<h2>🔨 Roaming Blacksmith 🔨</h2>

<table>
  <tr>
    <td><img src="/static/blacksmith.jpg" width=150 height=150>
    </td>
    <td><p>You encounter a Roaming Blacksmith that can repair an item in your inventory. You have <b>{{ team.gold }} ₿.</b> Which item will you repair?</p>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flashes">
            {% for category, message in messages %}
              <b> <class="flash {{ category }}">{{ message }}</b><br>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}



    </td>
  </tr>
  <tr>
    <td colspan="2">
      <select id="item-select">
        {% for item in broken_items %}
            <option value="{{ item.id }}">{{ item.item_name }} ({{ item.uses_remaining }} uses)</option>
        {% endfor %}
      </select>

      <button onclick="requestQuote()">🔧 Get Repair Quote</button>
      <div id="blacksmith-thinking" style="display: none;">
        <p>🧠 The Blacksmith grunts and rubs his beard, thinking it over...</p>
      </div>

      <div id="blacksmith-response"></div>

      {% if session.get("blacksmith_reply") %}
        <div class="blacksmith-reply">
          <p><strong>Smith’s final price:</strong> {{ session.pop("blacksmith_reply") }}</p>
          <form method="POST" action="{{ url_for('town.blacksmith') }}">
            <input type="hidden" name="item_id" value="{{ session.get('blacksmith_item_id') }}">
            <label>Your Counter Offer (bits):</label>
            <input type="number" name="bitcoin" required>
            <button type="submit">💬 Haggle Again</button>
            <button
              type="button"
              id="accept_button"
              data-offer="{{ session.get('blacksmith_offer') }}"
              disabled
            >
              🏳️ Accept {{ session.get('blacksmith_offer') }} ₿
            </button>
          </form>
        </div>
      {% endif %}


    </td>
  </tr>
  <tr><td colspan="2">
    <p><a href="{{ url_for('map_view') }}">Decline and move on</a></p>
  </td></tr>
</table>


<script>
function requestQuote() {
  const itemId = document.getElementById('item-select').value;

  // Show "thinking" message
    document.getElementById('blacksmith-thinking').style.display = 'block';
    document.getElementById('blacksmith-response').innerHTML = '';  // Clear old response


  fetch('/api/repair_quote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: itemId })
  })
  .then(res => res.json())
  .then(data => {
      if (data.error) {
          alert(data.error);
      } else {
          document.getElementById('blacksmith-response').innerHTML = `
              <p><strong>Blacksmith:</strong> ${data.message}</p>
              <form method="POST" action="/blacksmith">
                  <input type="hidden" name="item_id" value="${data.item_id}">
                  <label for="bitcoin">Your Offer (bits):</label>
                  <input type="number" name="bitcoin" required>
                  <button type="submit">💰 Submit Offer</button>
              </form>
          `;
      }
  });
}
</script>


{% endblock %}
